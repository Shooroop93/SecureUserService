# SecureUserService

**SecureUserService** ‚Äî —ç—Ç–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –∏—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–±–æ—Ç–æ–π —Å JWT-—Ç–æ–∫–µ–Ω–∞–º–∏. –ü–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ **Java + Spring Boot + gRPC**, —Å —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –∏ —É–ø–æ—Ä–æ–º –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.

---

## üöÄ –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (email/login + password).
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ email (—Å—Å—ã–ª–∫–æ–π).
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è JWT-—Ç–æ–∫–µ–Ω–æ–≤: **Access** –∏ **Refresh**.
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ `refresh_token`.
- Logout —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤—ã—Ö–æ–¥–∞ –∏–∑ **–≤—Å–µ—Ö —Å–µ—Å—Å–∏–π** –∏–ª–∏ **—Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏**.
- –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ PostgreSQL –∏ Redis.
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (USER, ADMIN).
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Ç–æ–∫–µ–Ω–∞–º–∏ —á–µ—Ä–µ–∑ PostgreSQL.
- Liquibase –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
- gRPC API –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏.

---

## ‚öôÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. **gRPC API**
- `AuthService`:
    - `Register` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    - `Login` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Access/Refresh —Ç–æ–∫–µ–Ω–æ–≤.
    - `RefreshToken` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Access/Refresh –ø–∞—Ä—ã.
    - `Logout` ‚Äî –æ—Ç–∑—ã–≤ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ –∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é.

### 2. **REST API**
- `/api/user/confirm/{uuid}` ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ email-—Å—Å—ã–ª–∫—É.

### 3. **–°–µ—Ä–≤–∏—Å—ã**
- `UsersService` ‚Äî CRUD –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
- `RegistrationConfirmationService` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Å—ã–ª–æ–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
- `RedisService` ‚Äî —Ä–∞–±–æ—Ç–∞ —Å Redis.
- `TokenService` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –æ—Ç–∑—ã–≤, —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤.
- `LoginService` ‚Äî –ª–æ–≥–∏–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
- `RoleService` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ (–≤ –±—É–¥—É—â–µ–º).

### 4. **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏**
- `UsersRepository` ‚Äî –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Ç–∞–±–ª–∏—Ü–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
- `TokensRepository` ‚Äî —Ä–∞–±–æ—Ç–∞ —Å JWT —Ç–æ–∫–µ–Ω–∞–º–∏ –≤ –±–∞–∑–µ.

### 5. **–ú–æ–¥–µ–ª–∏ (Entities)**
- `Users` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Ñ–ª–∞–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, —Å–≤—è–∑–∫–∞ —Å —Ç–æ–∫–µ–Ω–∞–º–∏.
- `Tokens` ‚Äî Access/Refresh —Ç–æ–∫–µ–Ω—ã: `revoked`, `expires_at`, `token_type`, `session_id`.

### 6. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
- Spring Security (—á–∞—Å—Ç–∏—á–Ω–æ).
- JWT —Ç–æ–∫–µ–Ω—ã —Å `jti`, `session_id`, `exp`, `role` –∏ –¥—Ä—É–≥–∏–º–∏ claim'–∞–º–∏.
- BCrypt –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π.
- –í–∞–ª–∏–¥–∞—Ü–∏—è email —á–µ—Ä–µ–∑ `EmailValidator`.
- –û—Ç–∑—ã–≤ —Ç–æ–∫–µ–Ω–æ–≤ –≤ Redis –∏ –ë–î.
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è `revoked`.

### 7. **–ú–∏–≥—Ä–∞—Ü–∏–∏**
- Liquibase: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `db/changelog/changeset/v1/...`.
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ç–∞–±–ª–∏—Ü–∞–º, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –∏–Ω–¥–µ–∫—Å—ã.

### 8. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
- –õ–æ–≥–∏–∫–∞ `Slf4j`: –≤—Ö–æ–¥/–≤—ã—Ö–æ–¥, –æ—à–∏–±–∫–∏, —É—Å–ø–µ—à–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è.

---

## üìÑ gRPC API-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

- `Register` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- `Login` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Access/Refresh —Ç–æ–∫–µ–Ω–æ–≤.
- `RefreshToken` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤.
- `Logout` ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ —Å–µ—Å—Å–∏–∏ –∏–ª–∏ –≤—Å–µ—Ö —Å—Ä–∞–∑—É.

---

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

- ‚úÖ PostgreSQL + Liquibase + –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ email.
- ‚úÖ Login (—Å–µ—Å—Å–∏–∏, —Ç–æ–∫–µ–Ω—ã).
- ‚úÖ Refresh Token (–ø–æ `refresh_token`, —Å –æ—Ç–∑—ã–≤–æ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å–µ—Å—Å–∏–∏).
- ‚úÖ Logout (–≤—Å—è —Å–µ—Å—Å–∏—è –∏–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞).
- ‚úÖ JWT (HS512, JTI, —Ä–æ–ª–∏, session_id, –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏).
- ‚úÖ Redis + PostgreSQL –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –æ—Ç–∑—ã–≤–∞.
- ‚úÖ –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: `RedisService`, `UsersService`, `RegistrationConfirmationService`, `LoginService`, `TokenService`.
- ‚úÖ gRPC API: Register, Login, RefreshToken, Logout.

---

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Java 21**
- **Spring Boot 3.x**
- **Spring Security**
- **gRPC**
- **JWT**
- **Redis**
- **PostgreSQL**
- **Liquibase**
- **Docker (–≤ –±—É–¥—É—â–µ–º)**

---

## ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–ø—É—Å–∫ PostgreSQL –∏ Redis
```bash
docker-compose up -d
```

### 2. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```bash
./mvnw spring-boot:run
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ gRPC API
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å gRPC-–∫–ª–∏–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, BloomRPC, Insomnia, Postman).

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
```http
GET http://localhost:8080/api/user/confirm/{uuid}
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –ü–∞—Ä–æ–ª–∏: `BCrypt`.
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: Redis-—Å—Å—ã–ª–∫–∞ TTL.
- –¢–æ–∫–µ–Ω—ã: Access/Refresh JWT, —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL + Redis.
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ `revoked`.

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `application-secrets.yml`
```yaml
spring:
  datasource:
    url: url
    username: username
    password: password
  data:
    redis:
      host: host
      port: port
      username: default
      password: password

  security:
    jwt:
      secret: secret
      expiration:
        access: 0
        refresh: 0
```
---
